// Copyright (c) 2014 AEFIS, all rights reserved.
// http://www.aefis.com/
"use strict";

if (!aefis) {
    aefis = {};
};

if (typeof(aefis.widgetClasses) == 'undefined') {
    aefis.widgetClasses = {};
};

if (typeof(aefis.widget) == 'undefined') {
    aefis.widget = {};
};

//define class in aefis.widgetClasses 2
//use widget code (defined in database) for the name
aefis.widgetClasses.assessmentsfac = function($rootContainer) {
    var that = this;
    var $widget = $('#aefis-dashboard-widget--assessmentsfac');
    this.initialize = function($rootContainer) {
        if (!$rootContainer) {
            $rootContainer = $('body');
        };

        if ($rootContainer.is('body')) {
            that.getAssessmentData('#aefis-dashboard-widget--assessmentsfac--current');
        };

        $widget.on('AefisWidgetMenuEvent:current', function() {
            that.getAssessmentData('#aefis-dashboard-widget--assessmentsfac--current');
        });

        $widget.on('AefisWidgetMenuEvent:previous', function() {
            that.getAssessmentData('#aefis-dashboard-widget--assessmentsfac--previous');
        });

        $widget.on('AefisDashboardWidget:refresh', function() {
			that.getAssessmentData('#aefis-dashboard-widget--assessmentsfac--current');
		});
    };

    this.getAssessmentData = function(button) {
        var $button = $(button);
        var url = $button.attr('data-aefis-datasource');
        var type = $button.attr('data-aefis-type');
        var templateid = $button.attr('data-aefis-template-id');
        var target = $button.attr('data-aefis-target');
        var source = $('#' + templateid).html();
        var template = Handlebars.compile(source);
        var $target = $(target);

        new aefis.ApiWrapper().call(url, {
            beforeSend: function() {
                $target.html('');
                $widget.trigger('AefisDashboardWidget:loading');
            },
            onComplete: function() {
                $widget.trigger('AefisDashboardWidget:loaded');
            },
            onSuccess: function(data) {
                $target.fadeOut().promise().done(function() {
                    $target.html(template({ records: data })).promise().done(function() {
                        $target.fadeIn().promise().done(function() {
                            $(window).trigger('refreshDOMObjects');
                        });
                    });
                });
            }
        });
    };

}