// Copyright (c) 2017 AEFIS, all rights reserved.
// http://www.aefis.com/
"use strict";

if (!aefis) {
    aefis = {};
};

if (!aefis.widgetClasses) {
    aefis.widgetClasses = {};
};

if (!aefis.widget) {
    aefis.widget = {};
};

aefis.widgetClasses.courseevaluations = function ($rootContainer) {
    var that = this;
    var $widget = $('#aefis-dashboard-widget--courseevaluations');
    this.initialize = function($rootContainer) {
        if (!$rootContainer) {
            $rootContainer = $('body');
        };

        if ($rootContainer.is('body')) {
            that.getAssessmentData('#aefis-dashboard-widget--courseevaluations--current');
        };

        $widget.on('AefisWidgetMenuEvent:current', function() {
            that.getAssessmentData('#aefis-dashboard-widget--courseevaluations--current');
        });

        $widget.on('AefisWidgetMenuEvent:previous', function() {
            that.getAssessmentData('#aefis-dashboard-widget--courseevaluations--previous');
        });

        $widget.on('AefisDashboardWidget:refresh', function() {
			that.getAssessmentData('#aefis-dashboard-widget--courseevaluations--current');
		});
    };

    this.getAssessmentData = function(button) {
        var $button = $(button);
        var url = $button.attr('data-aefis-datasource');
        var templateid = $button.attr('data-aefis-template-id');
        var target = $button.attr('data-aefis-target');
        var source = $('#' + templateid).html();
        var template = Handlebars.compile(source);
        var $target = $(target);

        new aefis.ApiWrapper().call(url, {
            beforeSend: function() {
                $target.html('');
                $widget.trigger('AefisDashboardWidget:loading');
            },
            onComplete: function() {
                $widget.trigger('AefisDashboardWidget:loaded');
            },
            onSuccess: function(data) {
                $target.fadeOut().promise().done(function() {
                    $target.html(template({ records: data })).promise().done(function() {
                        $(window).trigger('refreshDOMObjects');
                        $target.fadeIn();
                    });
                });
            }
        });
    };
    
}