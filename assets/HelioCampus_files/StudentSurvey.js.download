// Copyright (c) 2016 AEFIS, all rights reserved.
// http://www.aefis.com/
"use strict";

if (!aefis) {
	aefis = {};
};

if (!aefis.widgetClasses) {
	aefis.widgetClasses = {};
};

if (!aefis.widget) {
	aefis.widget = {};
};

aefis.widgetClasses.studentsurvey = function ($rootContainer) {
	var that = this;
	var $widget = $('#aefis-dashboard-widget--studentsurvey');
	this.initialize = function($rootContainer) {
		if (!$rootContainer) {
			$rootContainer = $('body');
		};

		$widget.on('refresh', function() {
			that.refresh();	
		})

		$widget.on('AefisDashboardWidget:refresh', function() {
			that.refresh();	
		});

		$widget.on('AefisWidgetMenuEvent:current', function() {
			that.surveysToTakeTab('#aefis-student-survey--current');
		})

		$widget.on('AefisWidgetMenuEvent:past', function() {
			that.previousSurveysTab('#aefis-student-survey--previous');
		})

		$widget.on('AefisWidgetMenuEvent:calendar', function() {
			var $calendarContainer = $('#aefis-student-survey-calendar-button');
			aefis.ui.aefisDialog($calendarContainer);
		})

		that.refresh();
	};

	this.initializeCalendar = function() {
		var eventsArray = [];
		var $calendarEventsContainer = $('#aefis-student-survey-widget-calender-event-container');
		var calendarJSON = $calendarEventsContainer.html();
		if (calendarJSON.length && calendarJSON.trim() != '') {
			var $calendarJSON = JSON.parse(calendarJSON);
			$($calendarJSON).each(function() {
				var $row = $(this)[0];
				var calendarEvent = {};
				var canComplete = $row.CanComplete
				var startDate = $row.StartDate
				var endDate = $row.EndDate
				var title = $row.SurveyName
						
				calendarEvent = {
					title: title,
					start: startDate,
					end: endDate
				};
				eventsArray.push(calendarEvent);
			});
		};
		
		$('.aefis-ui-dialog').find('#aefis-student-survey-widget-calender').fullCalendar({
			height: 650,
			events: eventsArray,
			allDay: true
		});
	}

	this.refresh = function () {
		that.surveysToTakeTab('#aefis-student-survey--current');
	}

	this.surveysToTakeTab = function (el) {
		var $obj = $(el);
		var url = $obj.attr('data-aefis-datasource');
       	var templateid = $obj.attr('data-aefis-template-id');
       	var source = $('#'+templateid).html(); 
		var template = Handlebars.compile(source); 
		var $target = $($obj.attr('data-aefis-target'));
		var $calendarEventsContainer = $('#aefis-student-survey-widget-calender-event-container');
       	new aefis.ApiWrapper().call(url,{
			beforeSend: function() {
				$widget.trigger('AefisDashboardWidget:loading');
			},
			onSuccess: function(data){
				$widget.trigger('AefisDashboardWidget:loaded');
				$target.fadeOut(function(){
					$target.html(template({records: data}));
					if (data && data.length) {
						$calendarEventsContainer.html(JSON.stringify(data));
					};
					$target.fadeIn();
				});		
			}
		});
	};

	this.previousSurveysTab = function (el) {
		var $obj = $(el);
		var url = $obj.attr('data-aefis-datasource');
		var templateid = $obj.attr('data-aefis-template-id');
       	var source = $('#'+templateid).html(); 
		var template = Handlebars.compile(source); 
		var $target = $($obj.attr('data-aefis-target'));
       	new aefis.ApiWrapper().call(url,{
			beforeSend: function() {
				$widget.trigger('AefisDashboardWidget:loading');
			},
			onSuccess: function(data){
				$widget.trigger('AefisDashboardWidget:loaded');
				$target.fadeOut(function(){
					$target.html(template({records: data}));
					$target.fadeIn();
				});	
			}
		});
	};

	this.computeResponseRate = function(el) {
		var $obj = $(el);
		var $container = $('#aefis-sa-current-student-surveys-container');
		var total = $container.find('li.aefis-student-surveys-widget-completed-row').length;
		var completed = $container.find('li.aefis-student-survey-widget-completed').length;
		var notCompleted =  $container.find('li.aefis-student-survey-widget-not-completed').length;
		var $progressBar = $('#aefis-student-survey-widget-overall-progress-bar');
		var progressBarTitle = completed+' of ' + total + ' completed';
		$progressBar.attr('data-aefis-total', total);
		$progressBar.attr('data-aefis-completed', completed);
		$progressBar.attr('data-aefis-title', progressBarTitle);
		aefis.ui.aefisProgressBar($progressBar);
		$progressBar.fadeIn();
	};


}