// Copyright (c) 2013 AEFIS, all rights reserved.
// http://www.aefis.com/

"use strict";

var buttonGroup = {
	_init: function () {
		var self = this;
		//this._adjustSelectees();
		//this._setIcons();
		$(this.element).find('button').click(function (e) {
			function joinValues($list) {
				return $list.map(function() {
				  return $(this).attr("val")
				}).get().join(',');				
			}
			e.stopPropagation();
			var value = '';
			if ($(this).parent('div').attr('data-toggle') == 'buttons-radio') {
				value = $(this).attr('val');
				var target = $(this).parent('div').attr('data-aefis-target');
				if (target) {
					if ($(target).attr('data-aefis-default-value')) {
						var defaultValue = $(target).attr('data-aefis-default-value');
						var alreadyActive = false;
						$(this).parent('div').find('button.btn').each(function(){
							if ($(this).hasClass('active')) {
								alreadyActive = true;
							}
						});
						if (alreadyActive == 'false') {
							$(this).parent('div').find('button[val='+defaultValue+']').click();
						}
					};
					$(target).val(value);
				};
				$(this).parent('div').find('button.btn').removeClass('active');
				$(this).addClass('active');

			} else {
				if ($(this).attr('val') === '0') {
					if (!$(this).hasClass('active')) {
						$(this).parent().find("button[val!='0']").removeClass('active');
						$(this).addClass('active');
					}
				} else {
					if ($(this).hasClass('active')) {
						$(this).removeClass('active');
					} else {
						$(this).addClass('active');
					}
					if ($(this).parent('div').find("button.active[val!='0']").length === 0) {
						$(this).parent('div').find("button[val='0']").addClass('active');
					}
					if ($(this).parent('div').find("button.active[val!='0']").length > 0) {
						$(this).parent('div').find("button[val='0']").removeClass('active');
					}
					if ($(this).parent('div').find("button.active[val!='0']").length === $(this).parent('div').find("button[val!='0']").length) {
						$(this).parent('div').find("button[val='0']").addClass('active');
						$(this).parent('div').find("button[val!='0']").removeClass('active');
					}
				}
				value = joinValues($(this).parent('div').find("button.active"));
			};

			if ($(this).parent('div').val() != value) {
				$(this).parent('div').val(value);
				$(this).parent('div').trigger('change');
			}
		}).filter('button[val="0"]').addClass('active');
	},
	select: function (selector) {
		var values = selector.split(',');
		var self = this;

		$(self.element).find("button").removeClass('active');

		if (values.length > 0) {
			$.each(values, function (i, val) {
				$(self.element).find("button[val='" + val + "']").addClass('active');			
			});			
		}
		if ($(self.element).find("button.active[val!='0']").length === 0) {
			$(self.element).find("button[val='0']").addClass('active');
		}		
	},
	getSelected: function () {
		if ($(this.element).find('li.ui-selected#all').length) {
			return null;
		}
		var selected = new Array();

		$(this.element).find('li.ui-selected').not('#all').each(function (index, item) {
			selected.push($(item).val());
		});
		return selected;
	},
	options: {
		selectSingle: true,
		alwaysSelectOne: false,
		setIcons: false
	}
};

$.widget("aefis.buttonGroup", buttonGroup);